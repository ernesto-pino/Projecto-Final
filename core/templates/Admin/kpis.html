{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>KPIs de Citas – MiHora Lampa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">KPIs de Citas</h1>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'recepcion_home' %}">Volver</a>
  </div>

  <!-- Filtros -->
  <form id="filtros" class="row g-2 mb-3">
    <div class="col-sm-3">
      <label class="form-label">Desde</label>
      <input type="date" class="form-control" name="desde" value="{{ default_desde }}">
    </div>
    <div class="col-sm-3">
      <label class="form-label">Hasta</label>
      <input type="date" class="form-control" name="hasta" value="{{ default_hasta }}">
    </div>
    <div class="col-sm-4">
      <label class="form-label">Profesional</label>
      <select class="form-select" name="prof">
        <option value="">Todos</option>
        {% for pr in profesionales %}
          <option value="{{ pr.id }}">{{ pr.apellido }}, {{ pr.nombre }} – {{ pr.especialidad.nombre }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-2 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">Aplicar</button>
    </div>
  </form>

  <!-- KPI Cards -->
  <div class="row g-3 mb-3" id="kpi-cards">
    <div class="col-md-2"><div class="card text-center"><div class="card-body"><div class="text-muted">Total</div><div class="fs-4 fw-bold" id="kpi-total">—</div></div></div></div>
    <div class="col-md-2"><div class="card text-center"><div class="card-body"><div class="text-muted">Atendidas</div><div class="fs-4 fw-bold" id="kpi-atendidas">—</div></div></div></div>
    <div class="col-md-2"><div class="card text-center"><div class="card-body"><div class="text-muted">Ausentes</div><div class="fs-4 fw-bold" id="kpi-ausentes">—</div></div></div></div>
    <div class="col-md-2"><div class="card text-center"><div class="card-body"><div class="text-muted">Canceladas</div><div class="fs-4 fw-bold" id="kpi-canceladas">—</div></div></div></div>
    <div class="col-md-2"><div class="card text-center"><div class="card-body"><div class="text-muted">Confirmadas</div><div class="fs-4 fw-bold" id="kpi-confirmadas">—</div></div></div></div>
    <div class="col-md-2"><div class="card text-center"><div class="card-body"><div class="text-muted">Asistencia</div><div class="fs-4 fw-bold" id="kpi-asistencia">—%</div></div></div></div>
  </div>

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">Series semanales por estado</div>
        <div class="card-body">
          <canvas id="chLine" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">Distribución por estado</div>
        <div class="card-body">
          <canvas id="chPie" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = sel => document.querySelector(sel);
let chLine, chPie;

function palette(n){
  // paleta simple pero consistente
  const colors = [
    '#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f',
    '#edc948','#b07aa1','#ff9da7','#9c755f','#bab0ab'
  ];
  while(colors.length < n){ colors.push('#bab0ab'); }
  return colors.slice(0,n);
}

function toDatasets(series, labels){
  const estados = Object.keys(series);
  const cols = palette(estados.length);
  return estados.map((est, i) => ({
    label: est,
    data: series[est],
    borderColor: cols[i],
    backgroundColor: cols[i],
    tension: .2
  }));
}

async function fetchData(){
  const params = new URLSearchParams(new FormData($('#filtros'))).toString();
  const res = await fetch(`{% url 'recep_kpis_data' %}?${params}`);
  return await res.json();
}

function renderCharts(data){
  const labels = data.labels_semanas;
  const datasets = toDatasets(data.series, labels);

  // Line
  if (chLine) chLine.destroy();
  chLine = new Chart($('#chLine'), {
    type: 'line',
    data: { labels, datasets },
    options: { responsive: true, maintainAspectRatio: false }
  });

  // Pie
  const distKeys = Object.keys(data.distribucion);
  const distVals = distKeys.map(k => data.distribucion[k]);
  if (chPie) chPie.destroy();
  chPie = new Chart($('#chPie'), {
    type: 'doughnut',
    data: {
      labels: distKeys,
      datasets: [{ data: distVals, backgroundColor: palette(distKeys.length) }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

function renderKPIs(k){
  $('#kpi-total').textContent = k.total;
  $('#kpi-atendidas').textContent = k.atendidas;
  $('#kpi-ausentes').textContent = k.ausentes;
  $('#kpi-canceladas').textContent = k.canceladas;
  $('#kpi-confirmadas').textContent = k.confirmadas;
  $('#kpi-asistencia').textContent = (k.tasa_asistencia ?? 0) + '%';
}

async function boot(){
  const data = await fetchData();
  renderCharts(data);
  renderKPIs(data.kpis);
}

$('#filtros').addEventListener('submit', async (e) => {
  e.preventDefault();
  await boot();
});

boot();
</script>
</body>
</html>
